import type { ContentNode, CachedPage } from "../content/types.ts";

export interface BuildData {
  contentIndex: ContentNode[];
  pages: Record<string, CachedPage>;
  markdown: Record<string, string>;
  templates: Record<string, string>;
  fileHashes: Record<string, string>;
}

/** Escape a string for use in a JS single-quoted string literal. */
function escapeForSingleQuote(s: string): string {
  return s.replace(/\\/g, "\\\\").replace(/'/g, "\\'").replace(/\n/g, "\\n").replace(/\r/g, "\\r");
}

/**
 * Generate a TypeScript module that exports all pre-computed build data.
 * Uses JSON.parse() so the output is type-compatible with KvikkPressConfig
 * without needing type imports (JSON.parse returns any).
 */
export function generateBuildOutput(data: BuildData): string {
  const exports = [
    ["contentIndex", data.contentIndex],
    ["pages", data.pages],
    ["markdown", data.markdown],
    ["templates", data.templates],
    ["fileHashes", data.fileHashes],
  ] as const;

  const lines: string[] = [
    "// Generated by kvikkpress build â€” do not edit",
    "// deno-lint-ignore-file",
    "",
  ];

  for (const [name, value] of exports) {
    const json = JSON.stringify(value);
    lines.push(`export const ${name} = JSON.parse('${escapeForSingleQuote(json)}');`);
    lines.push("");
  }

  return lines.join("\n");
}
